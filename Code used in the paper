---
title: ""
author: "Ferrera Laila"
date: 13-11-22
---
#Libraries
library(Dada2) (Benjamin J Callahan et al. 2016)
library(tidyverse) (Wickham et al. 2019)
library(lme4) (Bates et al. 2015)
library(phangorn) (Schliep 2011)
library(plotly)  (Sievert 2020)
library(vegan) (Oksanen et al. 2013)
library(VennDiagram) (Chen 2022)
library(microbiome) # data analysis and visualisation  (Lahti et Shetty s. d.)
library(phyloseq) # also the basis of data object. Data analysis and visualisation (McMurdie et Holmes 2013)
library(microbiomeutilities) # some utility tools (Shetty et Lahti s. d.)
library (MetBrewer) # nice color options (Blake s. d.)
library (DT) # interactive tables in html and markdown
library(data.table) # alternative to data.frame
library(microbial)

#We started the analysis from the received the sequence table without chimera sequences

#import seqtab nochim
seqtab.nochim <- readRDS("seqtab_nochim.rds")
seqtab <- readRDS("seqtab.rds")
  
#Taxonomy assignment
taxa_a <- assignTaxonomy(seqtab.nochim, "~/Work space/My data/metagenomics_analysis-Germany/silva_nr99_v138.1_train_set.fa.gz", multithread=FALSE)
saveRDS(taxa_a, "taxa_a.rds")
 
#Add species
#dada2 assigns species using the addSpecies function
#The input for addSpecies is the output of  the taxonomic assignments, and species-level fasta sequence from database

taxa_species <- addSpecies(taxa_a, "~/Work space/My data/metagenomics_analysis-Germany/silva_species_assignment_v138.fa.gz")
saveRDS(taxa_species, "taxa_species.rds")

#Alignment package msa
#Multiple alignment
   seqs <- getSequences(seqtab.nochim)
   names(seqs) <- seqs # This propagates to the tip labels of the tree
   
#Construct multiple alignment
mult <- msa(seqs, method="ClustalW", type="dna", order="input")
saveRDS(mult, "mult.rds")
   
#Phylogenetic tree
#Construct the phylogenetic tree package phangorn
phang.align <- as.phyDat(mult, type="DNA", names=getSequence(seqtab))
dm <- dist.ml(phang.align)
treeNJ <- NJ(dm) # Note, tip order != sequence order
fit = pml(treeNJ, data=phang.align)

## negative edges length changed to 0!
fitGTR <- update(fit, k=4, inv=0.2)
fitGTR <- optim.pml(fitGTR, model="GTR", optInv=TRUE, optGamma=TRUE,
                    rearrangement = "stochastic", control = pml.control(trace = 0))
saveRDS(fitGTR, "fitGTR.rds")

# Construction of the phyloseq object
#read metadata
metadata <-read_excel("~/Work space/My data/metagenomics_analysis-Germany/16S paper.xlsx")
seqtab.nochim <- read_rds('~/Work space/My data/metagenomics_analysis-Germany/seqtab_nochim.Rds')

samples.out <- rownames(seqtab.nochim)
samdf <- metadata
rownames(samdf) <- samples.out
samdf <- cbind(samdf, metadata)
rownames(samdf) <- samples.out
samdf <- samdf[!duplicated(samdf$SampleID),] # Remove dupicate entries for reverse reads

#The pyloseq object ps
ps <- phyloseq(otu_table(seqtab_nochim, taxa_are_rows=FALSE), 
               sample_data(samdf),
               tax_table(taxa_species),
               phy_tree(fitGTR$tree))
sample_names (ps)

#Removing healthy samples that have a big abundance of gardnarella +Mock +NTC
ps <- prune_samples(  sample_names(ps) != "22Apr5828-DL083" &
                        sample_names(ps) != "22Apr5828-DL087" &
                        sample_names(ps) != "22Apr5828-DL088" &
                        sample_names(ps) != "22Apr5828-DL089" &
                        sample_names(ps) != "22Apr5828-DL102"&
                        sample_names(ps) != "22Apr5828-DL095"&
                        sample_names(ps) != "22Apr5828-DL096", ps)
ps

#Save  DNA sequences
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps))) #to remove DNA sequence as labels
saveRDS(ps, "ps.rds")

# Create table, number of features for each phyla
table(tax_table(ps)[, "Phylum"], exclude = NULL)

#CST 
##Diversity analysis
#Alpha diversity
#Beta diversity

